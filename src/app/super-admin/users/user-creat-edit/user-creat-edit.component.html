<div class="shadow-sm bg-light w-100 d-flex justify-content-between pt-2" mat-dialog-title>
  <div class="text-start col-10 fs-6">
    <button color="primary" mat-icon-button>
      <mat-icon>{{ isEditMode ? 'edit' : 'person_add' }}</mat-icon>
    </button>
    <span>{{ isEditMode ? 'Modifier l\'utilisateur' : 'Créer un utilisateur' }}</span>
  </div>
  <!-- Reset Button -->
  <div class="col-2 text-end">
    <button class="mx-2" color="primary" mat-icon-button (click)="userForm.reset()">
      <mat-icon>refresh</mat-icon>
    </button>
    <!-- Close Button -->
    <button class="" color="warn" mat-dialog-close mat-icon-button>
      <mat-icon>close</mat-icon>
    </button>
  </div>
</div>

<div mat-dialog-content class="w-100">
  <form [formGroup]="userForm" class="row">
    <mat-form-field appearance="outline" class="col-lg-6">
      <mat-label>Nom complet</mat-label>
      <input formControlName="name" matInput placeholder="Ex: Jean Dupont">
      <mat-error *ngIf="userForm.controls['name'].hasError('required')">
        Le nom est obligatoire
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col-lg-6">
      <mat-label>Matricule</mat-label>
      <input formControlName="matriculate" matInput placeholder="Ex: EMP001">
      <mat-error *ngIf="userForm.controls['matriculate'].hasError('required')">
        Le matricule est obligatoire
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col-lg-6">
      <mat-label>Adresse email</mat-label>
      <input formControlName="email" type="email" matInput placeholder="Ex: jean.dupont@example.com">
      <mat-error *ngIf="userForm.controls['email'].hasError('required')">
        L'email est obligatoire
      </mat-error>
      <mat-error *ngIf="userForm.controls['email'].hasError('email')">
        Veuillez entrer un email valide
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col-lg-6">
      <mat-label>Téléphone</mat-label>
      <input formControlName="phone" matInput placeholder="Ex: +212 6XX XXX XXX">
      <mat-error *ngIf="userForm.controls['phone'].hasError('required')">
        Le téléphone est obligatoire
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col-lg-6">
      <mat-label>Mot de passe</mat-label>
      <input formControlName="password" [type]="'password'" matInput [placeholder]="isEditMode ? 'Laisser vide pour ne pas modifier' : 'Généré automatiquement'">
      <div *ngIf="!isEditMode" class="mat-mdc-form-field-hint-wrapper">
        <div class="mat-mdc-form-field-hint">Le mot de passe sera généré automatiquement</div>
      </div>
      <mat-error *ngIf="userForm.controls['password'].hasError('required')">
        Le mot de passe est obligatoire
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col-lg-6">
      <mat-label>À propos</mat-label>
      <textarea formControlName="aboutMe" matInput rows="3" placeholder="Description optionnelle de l'utilisateur"></textarea>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col-lg-6">
      <mat-label>Sélectionner un rôle</mat-label>
      <mat-select formControlName="role" (selectionChange)="onRoleSelect($event)">
        <mat-option *ngFor="let role of roles | async" [value]="role">
          {{ role.role }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="userForm.controls['role'].hasError('required')">
        Le rôle est obligatoire
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col-lg-6">
      <mat-label>Droits d'accès</mat-label>
      <mat-select formControlName="rights" multiple>
        <mat-option *ngFor="let right of rights | async" [value]="right">
          {{ right.name }}
        </mat-option>
      </mat-select>
      <div *ngIf="selectedRights.length > 0" class="mat-mdc-form-field-hint-wrapper">
        <div class="mat-mdc-form-field-hint">{{ selectedRights.length }} droit(s) sélectionné(s)</div>
      </div>
    </mat-form-field>

    <!-- Selected Rights Display -->
    <div *ngIf="selectedRights.length > 0" class="col-lg-12 mb-3">
      <div class="d-flex flex-wrap gap-2">
        <mat-chip *ngFor="let right of selectedRights" (removed)="removeRight(right)" color="primary">
          {{ right.name }}
          <button matChipRemove>
            <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip>
      </div>
    </div>

    <!-- Company Selection -->
    <mat-form-field appearance="outline" class="col-lg-12">
      <mat-label>Sélectionner des entreprises</mat-label>
      <mat-select formControlName="companies" multiple (selectionChange)="onCompaniesChange()">
        <mat-option *ngFor="let company of companies | async" [value]="company.id">
          {{ company.name }}
        </mat-option>
      </mat-select>
      <div *ngIf="selectedCompanies.length > 0" class="mat-mdc-form-field-hint-wrapper">
        <div class="mat-mdc-form-field-hint">{{ selectedCompanies.length }} entreprise(s) sélectionnée(s)</div>
      </div>
    </mat-form-field>

    <!-- Selected Companies Display -->
    <div *ngIf="selectedCompanies.length > 0" class="col-lg-12 mb-3">
      <div class="d-flex flex-wrap gap-2">
        <mat-chip *ngFor="let company of selectedCompanies" (removed)="removeCompany(company)" color="accent">
          {{ company.name }}
          <button matChipRemove>
            <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip>
      </div>
    </div>
  </form>
</div>

<div mat-dialog-actions align="end">
  <button mat-button color="warn" mat-dialog-close>Annuler</button>
  <button *ngIf="isEditMode" mat-raised-button color="primary" (click)="createOrEditUser()" [disabled]="userForm.invalid">
    Enregistrer les modifications
  </button>
  <button *ngIf="!isEditMode" mat-raised-button color="primary" (click)="createOrEditUser()" [disabled]="userForm.invalid">
    Créer l'utilisateur
  </button>
</div>
